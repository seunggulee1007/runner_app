#!/bin/bash

# 색상 정의
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "🔍 API 키 노출 검사 중..."

# 커밋하려는 파일들에서 API 키 패턴 검색
API_KEY_PATTERNS=(
  "AIza[0-9A-Za-z_-]{35}"  # Google API 키 패턴
  "AKIA[0-9A-Z]{16}"        # AWS Access Key 패턴
  "sk-[a-zA-Z0-9]{48}"      # OpenAI API 키 패턴
)

# Staged 파일 목록
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

FOUND_SECRETS=0

for FILE in $STAGED_FILES; do
  # .env 파일은 제외 (이미 .gitignore에 있음)
  if [[ "$FILE" == ".env" ]]; then
    echo -e "${RED}❌ 오류: .env 파일을 커밋하려고 시도했습니다!${NC}"
    echo -e "${YELLOW}   .env 파일은 절대 Git에 커밋되어서는 안 됩니다.${NC}"
    FOUND_SECRETS=1
    continue
  fi
  
  # 각 패턴 검사
  for PATTERN in "${API_KEY_PATTERNS[@]}"; do
    if git diff --cached "$FILE" | grep -qE "$PATTERN"; then
      echo -e "${RED}❌ 오류: API 키가 발견되었습니다!${NC}"
      echo -e "${YELLOW}   파일: $FILE${NC}"
      echo -e "${YELLOW}   패턴: $PATTERN${NC}"
      FOUND_SECRETS=1
    fi
  done
done

if [ $FOUND_SECRETS -eq 1 ]; then
  echo ""
  echo -e "${RED}╔═══════════════════════════════════════════════════════════╗${NC}"
  echo -e "${RED}║  🚨 커밋 차단: API 키 또는 민감한 정보가 발견되었습니다!  ║${NC}"
  echo -e "${RED}╚═══════════════════════════════════════════════════════════╝${NC}"
  echo ""
  echo -e "${YELLOW}다음 조치를 취하세요:${NC}"
  echo "1. 파일에서 API 키를 제거하세요"
  echo "2. .env 파일에 API 키를 저장하세요"
  echo "3. 플레이스홀더를 사용하세요 (예: YOUR_API_KEY_HERE)"
  echo ""
  echo -e "${YELLOW}강제로 커밋하려면 (권장하지 않음):${NC}"
  echo "git commit --no-verify"
  echo ""
  exit 1
fi

echo "✅ API 키 검사 완료 - 안전합니다!"
exit 0
